<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>macOS Imaging and Testing / Keaton Burleson</title>
  <meta name="description" content="Prologue">
  <meta property="og:title" content="Keaton's Page" />
  
    <meta property="og:image" content="http://images.128keaton.com/Screen%20Shot%202018-08-10%20at%203.49.39%20PM.png" />
  
  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="/2018/08/10/moving-forward-with-macos-imaging.html">
  <link rel="alternate" type="application/rss+xml" title="Keaton Burleson" href="/feed.xml">
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" href="/apple_icon.png">
  
  <link href="https://fonts.googleapis.com/css?family=Lora" rel="stylesheet"> 
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.12/css/all.css" integrity="sha384-G0fIWCsCzJIMAVNQPfjH08cyYaUtMwjJwqiRKxxE/rx96Uroj1BtIQ6MLJuheaO9" crossorigin="anonymous">
</head>
 
<table class="header-container">
    <tr>
        <td>
            <a href="/">Home</a>
            <a href="/blog/">Blog</a>
            <a href="/#me">About</a>
        </td>
        <td>
            <h1>Keaton Burleson</h1>
        </td>
    </tr>
</table>



<body id="post">
    <div class="wrapper" id="white post">
            <article class="post post--full">
                <div class="post-head">
                    <h2 class="post-title">macOS Imaging and Testing</h2> 
                    <h3 class="post-date">August 10 2018</h3>
                </div>
                
                    <img class="post-head-image" src="http://images.128keaton.com/Screen%20Shot%202018-08-10%20at%203.49.39%20PM.png"> 
                
                <div class="post-content">
                    <h2 id="prologue">Prologue</h2>

<p>Now that macOS Imaging is dead (and <a href="https://support.apple.com/en-us/HT202770#sections">is never coming back</a>), I had to figure out a solution to replace DeployStudio here at ER2. Currently, we use a basic combination of cocoaDialog and bash to also mark the condition of any machine booted before imaging. The system is logged in our internal testing system and a label is adhered containing the specs. Then the machine is passed on to be cleaned before sale to a customer. This is great and all, but what if the machine has underlying issues, or severely overheats under strain <em>not</em> expressed during an install? Having a customer shipped what is essentially a defective laptop is the worst case scenario, but that inherently generates a lot of <em>waste</em> (at work, we are actively encouraged to eliminate waste)</p>

<h2 id="building-a-netboot-environment">Building a NetBoot environment</h2>

<p>The first idea was running a NetBoot recovery environment (similar to how Imagr or DeployStudio operates). Honestly, this is the way to do it. It boots extremely fast, only the bare minimum frameworks are loaded. For us, we get system specs using the <code class="highlighter-rouge">system_profiler</code> command, but in High Sierra‚Äôs recovery environment, you do not have access to this command. The framework is <em>not</em> included for some bizarre reason, but its Apple ü§∑üèª‚Äç‚ôÇÔ∏è.</p>

<p>Another caveat is that full acceleration GPU drivers are not loaded. Again, its to make the environment lighter and, I‚Äôm assuming, to allow it to boot in worse case scenarios where the GPU might be crippled, or the discrete GPU is disabled. Pure speculation on my part, however. The lack of full acceleration GPU drivers was another big problem for us. We use UNIGINE‚Äôs <a href="https://benchmark.unigine.com/heaven">Heaven</a> GPU stress-testing software to spot potential GPU/overheating problems.</p>

<p>So, really, the next solution was a full bootable OS with tools built into the image. Sure, you could add GPU acceleration to the existing Recovery environment. And then you‚Äôd add the required extensions. Then, you‚Äôve opened a can of worms. I do not know what I was doing wrong, but I couldn‚Äôt get a Recovery environment to properly boot with the added extensions that I needed. To make the base image required, I used a modified version of AutoCasperNBI. The modifications were simple‚ÄìAutoCasperNBI is an AppleScript-based project. If you do not know AppleScript, I‚Äôd recommend learning it, as it can make somethings like on boarding prompts, run-once applications, and droplets MUCH simpler than tackling a full Cocoa project.</p>

<p><img src="http://images.128keaton.com/Screen%20Shot%202018-08-12%20at%2012.08.25%20PM.png" alt="Screen Shot 2018-08-12 at 12.08.25 PM" /></p>

<p>The modifications essentially disabled the Casper part of the project while keeping everything else. I didn‚Äôt use Casper, nor did I need it. I just needed to make an NBI easily. I liked it the best (even with having to make modifications), since its easy to document for. I‚Äôd like to assume the person who will eventually replace me would appreciate a GUI-based application with screen shots to guide him/her through rebuilding an NBI.</p>

<h2 id="tools-and-testing">Tools and Testing</h2>

<p>Great. Perfect. We now have a fully bootable NBI. Next, we have to load it up with tools. As mentioned above, we use Heaven for GPU stress testing. For CPUs, we use <a href="https://www.mersenne.org/download/">GIMPS Prime95</a> and assign it ‚Äòwork‚Äô for 15 minutes. We time both Heaven and Prime95 with a custom application called <a href="https://github.com/128keaton/BarTimer">BarTimer</a>. To test the iSight camera, we simply use Photo Booth. Recording a video and playing it back tests speakers as well, knocking two birds out with one stone. To test USB ports, we use an application called <a href="https://github.com/128keaton/USBDetect">USBDetect</a> that plays a sound and displays a notification when a USB device is plugged in and recognized. Finally, when testing is complete, and the machine as been evaluated, a label is printed and the machine is added to an internal device tracker that keeps up with specs and configurations.</p>

<h2 id="installing-macos">Installing macOS</h2>

<p>Arguably, the best way to install OR upgrade to macOS High Sierra is using Apple‚Äôs <code class="highlighter-rouge">startosinstall</code> tool. It is a fantastic command line utility that will upgrade the machine‚Äôs firmware to allow booting from APFS drives. It also installs macOS in the way Apple likes‚Äìit behaves exactly how the installation application does. This is a great way to start a macOS install. However, I didn‚Äôt need this as we were starting from a full OS. But, we didn‚Äôt bundle the install application inside the NetBoot image. This would be irresponsible‚Äìit would double the image size AND require the image to update when a new version of macOS came out. The way we currently utilize is having a start up script (we actually use <a href="https://github.com/chilcote/outset">Outset</a> for this, fantastic utility) that mounts an NFS share containing the latest version of macOS. Then, a DMG containing the installer application is mounted, ready to install on the client machine.</p>

<h2 id="mocking-macos-utilities">Mocking ‚ÄòmacOS Utilities‚Äô</h2>

<p>We wanted a simple way to launch applications and establish a ‚Äòworkflow‚Äô of sorts. Sure, you could just use the Dock and Finder, but to an untrained user, it can easily be confusing. Our solution was a custom application, similar to the macOS Utilities you see on the Recovery partition.</p>

<p><img src="http://images.128keaton.com/screenshot.png" alt="" /></p>

<p>At the bottom, there is a button to launch a ‚ÄòmacOS Install Kickoff‚Äô application. The utilities pane waits for the <code class="highlighter-rouge">/Volumes/Install macOS High Sierra</code> volume to become available. The <a href="https://github.com/128keaton/macOS-Installer-Kickoff">kickoff</a> application checks for any existing APFS setup, removes it (since we are installing from Sierra), and erases the drive, readying it for install.</p>

<h2 id="final-notes">Final Notes</h2>

<p>Moving forward, with T2 Apple machines (which do not allow booting from an external volume at all), the majority of this setup can be moved to an external drive and the applications/scripts can be used in a recovery environment (minus Heaven).</p>

<p>If anyone reading this is currently testing machines similar to above, I‚Äôd love to see your setup! Always looking for improvements!</p>
 
                </div>
                

<section class="comments">
	<div class="constrain--body">
		<div class="comments__existing js-comments">
			
		</div>
		<form id="post-new-comment" class="form" action="https://api.staticman.net/v2/entry/128keaton/128keaton.com/pre-publish/comments" method="post">
    <input type="hidden" name="options[slug]" value="2018-08-10-macos-imaging-and-testing">
    <input type="hidden" name="options[parent]" value="2018-08-10-macos-imaging-and-testing">
    <input type="hidden" name="options[origin]" value="http://128keaton.com/2018/08/10/moving-forward-with-macos-imaging.html">
    <input name="options[redirect]" type="hidden" value="http://128keaton.com/2018/08/10/moving-forward-with-macos-imaging.html">

    <input type="text" name="company" class="text-field" style="display: none">
    <input class="form__field text-field" type="text" name="fields[name]" placeholder="Name" required/>
    <input class="form__field text-field" type="email" name="fields[email]" placeholder="Email address (will not be public)" required/>
    <input class="form__field text-field" type="url" name="fields[url]" placeholder="Website (optional)" />
    <input class="form__field text-field" type="address" name="fields[address]" placeholder="Address (do not fill!)" style="display: none" />
    <textarea class="form__field text-field" rows="10" name="fields[message]" placeholder="Comment. Markdown is accepted." required></textarea>
    <input class="cta" type="submit" value="Post comment" />
</form>

	</div>
</section>

            </article>
        <footer class="footer" id="post-footer">
	<h1>Read more:</h1>
	<table class="colophon">
		<tr>
		
		<td class="footer-post">
			<a href="/2018/08/10/moving-forward-with-macos-imaging.html">
				<h1>macOS Imaging and Testing</h1>
			</a>
		</td>
		
		<td class="footer-post">
			<a href="/2017/09/08/yahoo-widgets-2017.html">
				<h1>Yahoo! Widgets in 2017</h1>
			</a>
		</td>
		
		<td class="footer-post">
			<a href="/2017/04/12/how-i-got-312-on-a-3gs-from-2011.html">
				<h1>How I got 3.1.2 on a 3G[s] from 2011</h1>
			</a>
		</td>
		
	</tr>
	</table>
	&copy Keaton Burleson
</footer>

    </div>
</body>

</html>
